<div style="display: flex; align-items: flex-start">
  <div>
    <form>
      <input type="number" min="1" value="5" max="9" id="rowsh" />
      <input type="button" id="btn" value="создать таблицу" />
      <div id="timer">00:00.00</div>
    </form>
    <div>
      <table class="table" id="root" cellspacing="0" cellpadding="0"></table>
    </div>
  </div>
  <div class="records-container">
    <div class="record-title">Рекорды</div>
    <ul class="record-list" id="record-list">
      <!-- Пример элемента списка -->
      <!-- <li class="record-item">
        <div class="avatar" style="background-image: url('')" title="имя"></div>
        <div class="record-details">
          <div class="record-time">01:23:45</div>
          <div class="record-number" title="сетка">5x5</div>
        </div>
      </li> -->
      <!-- Конец элемента списка -->
      <!-- Тут можно добавить больше элементов списка с рекордами -->
    </ul>
  </div>
</div>

<style>
  :root {
    --success: #00ff37;
    --fail: #ff0062;
  }
  #timer {
    width: 84px;
    display: inline-block;
    margin-left: 30px;
    color: #000;
    font-size: 20px;
  }
  .cards_wrapper {
    display: flex;
    flex-flow: column nowrap;
    align-items: center;
    justify-content: flex-start;
    background-size: cover !important;
    background-position: center !important;
    background-image: url('./1.png');
    padding: var(--defPadding);
  }
  .table {
    border-collapse: collapse;
    margin: 0;
    margin-top: 50px;
    background-color: var(--navLightBg);
  }
  .cell {
    border: 2px solid rgb(202, 88, 88);
    padding: 30px;
    font-size: 30px;
    text-align: center;
  }
  td {
    cursor: pointer;
  }
  td:hover {
    background-color: #fff7149b;
  }
  .records-container {
    width: 200px;
    margin-left: var(--defPadding);
    border: 1px solid var(--navLightBg);
    border-radius: var(--borderRadius);
    padding: 8px;
    background-color: var(--navLightBg);
  }

  .record-title {
    text-align: center;
    font-size: 20px;
    margin-bottom: 20px;
  }

  .record-list {
    list-style: none;
    padding: 0;
  }

  .record-item {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
  }

  .avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 10px;
    background-size: cover;
    background-position: center;
  }

  .record-details {
    display: flex;
    justify-content: space-around;
    align-items: center;
    flex-grow: 1;
  }

  .record-time {
    font-weight: bold;
  }

  .record-number {
    background: #eee;
    padding: 5px 10px;
    border-radius: 5px;
    color: #000;
  }
</style>

<script defer>
  let src = '.programs/memory_numbers/request.js';
  import(src)
    .then(async (module) => {
      let records = await module.returnAllRecords();
      renderRecords(records);
    })
    .catch((error) => {
      console.log(error);
    });

  function renderRecords(records) {
    document.getElementById('record-list').innerHTML = '';
    records.forEach((user) => {
      document.getElementById(
        'record-list',
      ).innerHTML += `<li class="record-item">
      <div class="user_avatar user_avatar_small" title="">
      <a href="${
        'https://memessenger.ru/pages/profile_page/profile.html?id=' +
        user.userId
      }" target="_blanc">
        <img class="user_avatar_img openProfile" src="${
          user.avatar
        }" data-id="${user.userId}" alt=""/>
        </a>
      </div>
        <div class="record-details">
          <div class="record-time">${user.time}</div>
          <div class="record-number" title="сетка">${
            user.grid + 'x' + user.grid
          }</div>
        </div>
      </li>`;
    });
  }

  let currentTdNumber = 1;
  let maxTdNumber = 0;
  let timerInterval;
  let milliseconds = 0;
  let seconds = 0;
  let minutes = 0;
  const button = document.querySelector('#btn');
  let root = document.getElementById('root');

  button.addEventListener('click', startPlay);

  function startPlay() {
    currentTdNumber = 1;
    maxTdNumber = 0;
    shulte();
    startTimer();
    document.querySelectorAll('.cell').forEach((cell) => {
      let cellNumber = parseInt(cell.innerHTML);
      if (!isNaN(cellNumber) && cellNumber > maxTdNumber) {
        maxTdNumber = cellNumber;
      }
    });
    setListeners();
  }

  function endGame(str) {
    clearInterval(timerInterval);
    removeListeners();
    alert(str);
  }

  // задаем размер таблицы из формы
  function shulte() {
    root.innerHTML = '';
    let rowsh = +document.getElementById('rowsh').value;
    let vert = rowsh;
    let gor = rowsh;
    let dimension = vert * gor;
    // заполнение таблицы
    new Array(vert).fill().reduce(
      (c, n) => {
        let vert = document.createElement('tr');
        c.splice(0, gor).map((e) => {
          let cell = document.createElement('td');
          cell.className = 'cell';
          cell.innerHTML = e;
          cell.id = 'tdNumber_' + e;
          vert.appendChild(cell);
        });
        root.appendChild(vert);
        return c;
      },
      Array.from(Array(dimension + 1).keys())
        .splice(1)
        .sort(() => 0.5 - Math.random()),
    );
  }

  function setListeners() {
    let tdCards = [...document.getElementsByClassName('cell')];
    tdCards.forEach((element) => {
      element.addEventListener('click', clickHandler);
    });
  }

  function removeListeners() {
    let tdCards = [...document.getElementsByClassName('cell')];
    tdCards.forEach((element) => {
      element.removeEventListener('click', clickHandler);
    });
  }

  function clickHandler(e) {
    const clickedTdNumber = parseInt(e.currentTarget.id.split('_')[1]);
    if (clickedTdNumber === currentTdNumber) {
      e.currentTarget.style.backgroundColor = 'var(--success)';

      if (maxTdNumber === currentTdNumber) {
        import(src)
          .then(async (module) => {
            // const totalMilliseconds =
            //   (minutes * 3600 + seconds * 60 + Math.floor(milliseconds / 10)) *
            //   1000;

            // const databaseTime = new Date(totalMilliseconds)
            //   .toISOString()
            //   .substr(11, 12);
            const databaseTime = `${minutes}:${seconds}:${Math.floor(
              milliseconds / 10,
            )}`;
            let result = await module.checkNewRecord(
              databaseTime,
              +document.getElementById('rowsh').value,
            );
            if (result) {
              alert('Рекорд поставлен!');
              let records = await module.returnAllRecords();
              renderRecords(records);
            }
          })
          .catch((error) => {
            console.log(error);
          });
        endGame(
          'Победа. Ваше время: ' + minutes + ':' + seconds + '.' + milliseconds,
        );
      } else {
        currentTdNumber++;
      }
    } else {
      e.currentTarget.style.backgroundColor = 'var(--fail)';
      endGame('ПРОИГРАЛИ');
    }
  }

  function startTimer() {
    milliseconds = 0;
    seconds = 0;
    minutes = 0;
    clearInterval(timerInterval);
    timerInterval = null;
    timerInterval = setInterval(updateTimer, 10);
  }

  function updateTimer() {
    milliseconds += 10;

    if (milliseconds === 1000) {
      milliseconds = 0;
      seconds++;
    }

    if (seconds === 60) {
      seconds = 0;
      minutes++;
    }

    const formattedTime =
      padZero(minutes) +
      ':' +
      padZero(seconds) +
      ':' +
      padZero(Math.floor(milliseconds / 10));
    document.getElementById('timer').textContent = formattedTime;
  }

  function padZero(num) {
    return num.toString().padStart(2, '0');
  }
</script>
