<div class="puzzle_wrapper">
  <div class="settings_container">
    <label for="fileInput"> Загрузить фотографию </label>
    <input type="file" id="fileInput" accept="image/*" />
    <div class="puzzle_container">
      <div class="place_for_blocks"></div>
      <div class="photo_preview"></div>
    </div>
    <input
      type="range"
      id="opacityInput"
      min="0"
      max="1"
      step="0.1"
      value="1"
    />
    <div>
      <button class="generate_puzzle" id="generatePuzzleButton">
        Сгенерировать пазл
      </button>
      <button
        class="puzzle_check"
        id="puzzleCheck"
        onclick="alert(checkSequence())"
        disabled
      >
        Проверить
      </button>
    </div>
  </div>
  <div class="blocks_container">
    <!-- <div class="block"></div> -->
  </div>
</div>

<style>
  .puzzle_wrapper {
    display: flex;
    flex-flow: column nowrap;
    align-items: center;
    justify-content: flex-start;
    width: 950px;
    height: 100%;
    padding: 0;
    margin-right: var(--defPadding);
  }
  .settings_container {
    width: 100%;
    display: flex;
    flex-flow: column nowrap;
    align-items: center;
    justify-content: center;
  }
  #fileInput {
  }
  .puzzle_container {
    position: relative;
    width: 100%;
    height: 400px;
    margin-top: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .place_for_blocks {
    position: absolute;
    height: 100%;
    display: flex;
    flex-flow: row wrap;
    align-items: flex-start;
    justify-content: flex-start;
    align-content: flex-start;
    background: inherit;
    z-index: 10;
  }
  .photo_preview {
    width: 100%;
    height: 100%;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    transition: opacity 0.3s;
  }
  .generate_puzzle {
    margin-top: 15px;
  }
  .blocks_container {
    width: 100%;
    min-height: 100px;
    display: flex;
    flex-wrap: wrap;
    margin-top: 15px;
    perspective: 1000px;
    border: 2px solid #37a5ff;
    border-radius: var(--borderRadius);
  }
  .block {
    width: 25%;
    height: 25%;
    background-size: cover;
    background-position: center;
    cursor: pointer;
    transition: transform 0.3s;
  }
  .grid_container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 5px;
  }
  .puzzle_check {
    background-color: #37a5ff;
  }
</style>

<script defer>
  const fileInput = document.getElementById('fileInput');
  const opacityInput = document.getElementById('opacityInput');
  const generatePuzzleButton = document.getElementById('generatePuzzleButton');
  const photoPreview = document.querySelector('.photo_preview');
  const placeForBlocks = document.querySelector('.place_for_blocks'); //zone 1
  const blocksContainer = document.querySelector('.blocks_container'); //zone 2

  placeForBlocks.ondragover = allowDrop;
  blocksContainer.ondragover = allowDrop;

  function allowDrop(event) {
    event.preventDefault();
  }

  fileInput.addEventListener('change', function () {
    const file = this.files[0];
    const reader = new FileReader();

    reader.addEventListener('load', function () {
      photoPreview.style.backgroundImage = `url('${reader.result}')`;
    });

    if (file) {
      reader.readAsDataURL(file);
    }
  });

  opacityInput.addEventListener('input', function () {
    photoPreview.style.opacity = this.value;
  });

  let imageWidth;
  const imageHeight = 400; // Фиксированная высота 400px
  let blockWidth;
  const blockHeight = 100;
  const rowCount = imageHeight / blockHeight;
  const colCount = 4;

  generatePuzzleButton.addEventListener('click', generatePuzzle);

  function generatePuzzle() {
    if (!fileInput.files || !fileInput.files[0]) {
      alert('Файл с фотографией не выбран!');
      return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = function (event) {
      const image = new Image();
      image.onload = function () {
        imageWidth = image.width * (imageHeight / image.height); // Вычисляем ширину изображения с учетом высоты 400px
        placeForBlocks.style.width = imageWidth + 'px';
        const blockCount = colCount * rowCount;
        blockWidth = imageWidth / colCount;

        clearBlocks(); // Очистить предыдущие квадратики

        for (let row = 0; row < rowCount; row++) {
          for (let col = 0; col < colCount; col++) {
            // Создание и стилизация квадратиков
            const block = document.createElement('div');
            block.className = 'block';
            block.id = row + '' + col;
            block.draggable = 'true';
            block.style.width = blockWidth + 'px';
            block.style.height = blockHeight + 'px';

            // Обрезка и размещение фрагментов фото в квадратиках
            block.style.backgroundImage = `url(${event.target.result})`;
            block.style.backgroundSize = `${imageWidth}px ${imageHeight}px`;
            block.style.backgroundPosition = `-${col * blockWidth}px -${
              row * blockHeight
            }px`;

            // Перемещение квадратиков в случайный порядок TODO::
            const randomPosition = Math.floor(Math.random() * blockCount);
            blocksContainer.insertBefore(
              block,
              blocksContainer.children[randomPosition],
            );
          }
        }

        const blocks = document.querySelectorAll('.block');
        blocks.forEach((block) => {
          block.ondragstart = drag;
        });
      };

      image.src = event.target.result;
    };
    reader.readAsDataURL(file);
  }

  function clearBlocks() {
    const blocks = document.querySelectorAll('.block');
    blocks.forEach(function (block) {
      if (block.parentNode === blocksContainer) {
        blocksContainer.removeChild(block);
      }
    });
  }

  function drag(event) {
    event.dataTransfer.setData('id', event.target.id);
  }

  placeForBlocks.ondrop = drop;
  blocksContainer.ondrop = drop;

  function drop(event) {
    let itemId = event.dataTransfer.getData('id');
    event.target.append(document.getElementById(itemId));
    const blocksContainer = document.querySelector('.blocks_container');
    const isContainerEmpty = hasNoChildren(blocksContainer);
    const buttonCheck = document.getElementById('puzzleCheck');
    if (isContainerEmpty) {
      buttonCheck.disabled = false;
    } else {
      buttonCheck.disabled = true;
    }
  }

  function checkSequence() {
    const placeForBlocksElement = document.querySelector('.place_for_blocks');
    const blockElements = placeForBlocksElement.querySelectorAll('.block');

    let expectedId = 0;
    for (let i = 0; i < blockElements.length; i++) {
      const currentId = Number(blockElements[i].id);
      if (currentId < expectedId) {
        return 'Есть ошибка';
      }
      expectedId = currentId;
    }

    return 'Все верно';
  }

  function hasNoChildren(element) {
    return element.childElementCount === 0;
  }
</script>
