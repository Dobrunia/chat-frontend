<div class="program_wrapper">
  <div class="template">
    <div class="input-group mb-3">
      <div class="input-group-prepend">
        <span class="input-group-text dark_ed" id="inputGroup-sizing-default"
          >Заголовок файла</span
        >
      </div>
      <input
        type="text"
        class="form-control dark_ed"
        id="doc_title"
        aria-label="Default"
        aria-describedby="inputGroup-sizing-default"
      />
    </div>
    <div class="add_point">
      <button
        class="dark_ed"
        onclick="document.getElementById('template_list').style = 'height: max-content;'"
        style="margin-right: 30px"
      >
        v
      </button>
      <input
        id="points_num"
        class="dark_ed"
        type="number"
        min="1"
        max="25"
        step="1"
        value="1"
      />
      <button class="btn add_point_btn" onclick="addAllPoints()">+</button>
    </div>
    <div class="points_wrapper">
      <div class="template_list" id="template_list"></div>
      <div class="points_list" id="points_list"></div>
      <textarea
        class="notes dark_ed"
        id="notes"
        name="notes"
        placeholder="Заметки"
      ></textarea>
    </div>
    <button
      type="button"
      class="btn btn-success"
      id="sub"
      title="Скачать документ"
    >
      Готово
    </button>
  </div>
</div>

<style>
  .template {
    width: 100%;
    display: flex;
    flex-flow: column nowrap;
    align-items: center;
    justify-content: flex-start;
  }
  .add_point {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: flex-end;
  }
  .add_point_btn {
    margin-left: 10px;
    border: 1px solid #fff;
    color: var(--attention);
  }
  .add_point_btn:hover {
    color: #fff;
    border-color: var(--attention);
  }
  .points_wrapper {
    width: 100%;
    height: 100%;
    overflow-y: scroll;
  }
  .points_list {
    width: 100%;
    height: max-content;
    padding: var(--defPadding);
  }
  .point {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: var(--defPadding);
    margin-bottom: var(--defPadding);
  }
  .point_name {
    width: 500px;
  }
  .point_span {
    font-size: 18px;
    margin: 0 10px;
  }
  .stars span {
    font-size: 18px;
    margin: 0 10px;
  }
  .stars input {
    margin: 0 4px;
  }
  .notes {
    width: 100%;
    height: 100px;
  }
  .template_list {
    width: 100%;
    height: 0px;
    overflow: hidden;
    padding: var(--defPadding);
  }
  .select_input {
    height: max-content;
  }
  .hide-option {
    display: none;
  }
</style>

<script defer>
  document.getElementById('sub').addEventListener('click', downloadPointsData);
  let pointsNum = 0;

  let templateArray = [
    {
      templateName: 'softSkills',
      points: [
        { pointName: 'Время начала', pointType: 'Time' },
        {
          pointName: 'Опоздание',
          pointType: 'Select',
          pointOptions: ['Неуважительная', 'Уважительная'],
        },
        {
          pointName: 'Пришёл',
          pointType: 'Select',
          pointOptions: [
            'раньше',
            'вовремя',
            'от 5 мин. до 15 мин',
            'от 15 мин. и более',
          ],
        },
        {
          pointName: 'Сколько времени у вас есть для нашего разговора?',
          pointType: 'Select',
          pointOptions: [
            'да',
            'скорее да',
            'Сложно для определения',
            'скорее нет',
            'нет',
          ],
        },
        {
          pointName:
            'Расскажите о том, о чем вы готов поделиться сейчас, что то не связанное с нашим сегодняшним интервью?',
          pointType: 'Select',
          pointOptions: [
            'да',
            'скорее да',
            'Сложно для определения',
            'скорее нет',
            'нет',
          ],
        },
        {
          pointName: 'Почему откликнулся -лась именно на нашу вакансию?',
          pointType: 'Select',
          pointOptions: ['мотивация материальная', 'мотивация нематериальная'],
        },
        {
          pointName: 'Есть ли еще отклики и запланированные собеседования?',
          pointType: 'Select',
          pointOptions: [
            'да',
            'скорее да',
            'Сложно для определения',
            'скорее нет',
            'нет',
          ],
        },
        {
          pointName: 'Кандидат убедил специалиста о наличие опыта',
          pointType: 'Select',
          pointOptions: ['да', 'нет'],
        },
        {
          pointName: 'Физ. активность',
          pointType: 'Select',
          pointOptions: ['активный', 'пассивный'],
        },
        {
          pointName: 'Соц. навыки',
          pointType: 'Select',
          pointOptions: ['замкнутый', 'открытый'],
        },
      ],
    },
  ];

  function templatesRender() {
    templateArray.forEach((template) => {
      template.points.forEach((point) => {
        pointsNum++;
        const newPoint = createPointElement(
          point.pointName,
          point.pointType,
          point.pointOptions,
        );
        document.getElementById('template_list').appendChild(newPoint);
        addPointHandler(newPoint);
      });
    });
  }
  templatesRender();

  function downloadPointsData() {
    const pointsData = [];
    const pointElements = document.querySelectorAll('.point');
    let totalRating = 0;

    pointElements.forEach((point) => {
      let rating = null;
      let select = null;
      let time = null;
      const nameInput = point.querySelector('.point_name');

      if (point.querySelector('.stars_input')) {
        const ratingInputs = point.querySelectorAll(
          'input[name="' + point.id + '"]',
        );

        for (const input of ratingInputs) {
          if (input.checked) {
            rating = input.getAttribute('data-raiting');
            break;
          }
        }
        // Преобразуем значение в число для вычисления общего рейтинга
        totalRating += parseInt(rating);
      }

      if (point.querySelector('.choice_input')) {
      }

      if (point.querySelector('.time_input')) {
        const inputValue = point.querySelector('.time_input');
        if (inputValue) {
          time = inputValue.value;
        }
      }
      if (point.querySelector('.select_input')) {
        const inputValue = point.querySelector('.active_option');
        if (inputValue) {
          select = inputValue.value;
        }
      }

      const pointData = {
        id: point.id,
        name: nameInput.value
          ? nameInput.value
          : point.querySelector('.point_span').textContent,
        rating: rating ? rating : null,
        time: time ? time : null,
        select: select ? select : null,
      };
      pointsData.push(pointData);
    });

    const dataRows = pointsData
      .map(
        (point) =>
          `${point.name}: ${point.rating ? 'рейтинг - ' + point.rating : ''} ${
            point.time ? 'время - ' + point.time : ''
          } ${point.select ? 'выбрано- ' + point.select : ''}`,
      )
      .join('\n');
    const totalRow = `Итоговый (хард скиллы): ${totalRating}`;

    const notes = 'Заметка: ' + document.getElementById('notes').value || '';

    const fileName =
      document.getElementById('doc_title').value || 'собеседование';
    const creatorName = localStorage.getItem('username');
    const headerRow = `${'Собеседуемый: ' + fileName}\n${
      'Собеседовал: ' + creatorName
    }\n${totalRow}`;
    const fileContent = `${headerRow}\n${dataRows}\n${notes}`;

    const blob = new Blob([fileContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);

    const downloadLink = document.createElement('a');
    downloadLink.href = url;
    downloadLink.download = `${fileName}.txt`;
    downloadLink.click();
  }

  function addAllPoints() {
    let numbers = document.getElementById('points_num').value;
    for (let i = 0; i < numbers; i++) {
      addPoint();
    }
  }

  function addPoint() {
    pointsNum++;
    const newPoint = createPointElement(`Пункт (${pointsNum})`, 'Star', '');
    document.getElementById('points_list').appendChild(newPoint);
    addPointHandler(newPoint);
  }

  function createPointElement(pointName, pointType, pointOptions) {
    const pointWrapper = document.createElement('div');
    pointWrapper.classList.add('point');
    pointWrapper.id = pointsNum;

    const innerDiv = document.createElement('div');
    const deleteBtn = document.createElement('button');
    deleteBtn.classList.add('delete_point');
    deleteBtn.classList.add('dark_ed');
    deleteBtn.id = `delete_${pointsNum}`;
    deleteBtn.textContent = 'x';
    innerDiv.appendChild(deleteBtn);

    const span = document.createElement('span');
    span.textContent = pointName;
    span.classList.add('point_span');
    innerDiv.appendChild(span);

    const input = document.createElement('input');
    input.type = 'text';
    input.classList.add('point_name');
    input.classList.add('dark_ed');
    innerDiv.appendChild(input);

    pointWrapper.appendChild(innerDiv);

    switch (pointType) {
      case 'Choice':
        const choiceInput = document.createElement('input');
        choiceInput.type = 'number';
        choiceInput.min = '0';
        choiceInput.max = '1';
        choiceInput.classList.add('dark_ed');
        choiceInput.classList.add('choice_input');
        pointWrapper.appendChild(choiceInput);
        break;

      case 'Star':
        const starsDiv = document.createElement('div');
        starsDiv.classList.add('stars');
        starsDiv.classList.add('stars_input');
        const span1 = document.createElement('span');
        span1.textContent = '1';
        starsDiv.appendChild(span1);
        for (let i = 1; i <= 5; i++) {
          const radio = document.createElement('input');
          radio.type = 'radio';
          radio.setAttribute('data-raiting', i);
          radio.name = pointsNum;
          starsDiv.appendChild(radio);
        }
        const span5 = document.createElement('span');
        span5.textContent = '5';
        starsDiv.appendChild(span5);
        pointWrapper.appendChild(starsDiv);
        break;

      case 'Time':
        const timeInput = document.createElement('input');
        timeInput.type = 'time';
        timeInput.classList.add('dark_ed');
        timeInput.classList.add('time_input');
        pointWrapper.appendChild(timeInput);
        break;

      case 'Select':
        const selectInput = document.createElement('select');
        selectInput.type = 'select';
        selectInput.multiple = true;
        selectInput.classList.add('dark_ed');
        selectInput.classList.add('select_input');

        pointOptions.forEach((option) => {
          let optionElem = document.createElement('option');
          optionElem.value = option;
          optionElem.text = option;
          selectInput.appendChild(optionElem);
        });

        pointWrapper.appendChild(selectInput);

        selectInput.addEventListener('change', function () {
          const selectedOptions = Array.from(this.options).filter(
            (option) => option.selected,
          );

          // Перебираем все варианты и добавляем/удаляем классы
          Array.from(this.options).forEach((option) => {
            if (selectedOptions.includes(option)) {
              option.classList.add('active_option');
            } else {
              option.classList.remove('active_option');
              option.classList.add('hide-option');
            }
          });
        });
        break;

      default:
        break;
    }

    return pointWrapper;
  }

  function addPointHandler(point) {
    const deleteBtn = point.querySelector('.delete_point');
    deleteBtn.addEventListener('click', deletePoint);
  }

  function deletePoint(event) {
    const deleteBtn = event.target;
    const point = deleteBtn.parentNode.parentNode;
    point.remove();
  }
</script>
